<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZAD ULTIMATE 2026 | Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #10b981; --royal-green: #064e3b; --bg: #f0fdf4;
            --white: #ffffff; --danger: #ef4444; --text: #1f2937; --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--royal-green); color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 24px; font-weight: 900; color: var(--primary); margin-bottom: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .nav-item { padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.3s; color: #d1fae5; }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }

        /* Main */
        .main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Radar Alert */
        .radar-alert { background: #fee2e2; border-right: 5px solid var(--danger); padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--royal-green); font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-edit { background: #e0f2fe; color: #0369a1; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: right; background: #f8fafc; padding: 15px; color: var(--royal-green); border-bottom: 2px solid var(--primary); }
        td { padding: 12px; border-bottom: 1px solid #edf2f7; font-size: 14px; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .bg-xp { background: #fef9c3; color: #854d0e; }
        .bg-rank { background: #dbeafe; color: #1e40af; }

        .page-section { display: none; }
        .page-section.active { display: block; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 550px; padding: 30px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        
        /* Award Style */
        .award-badge { background: gold; color: #854d0e; padding: 10px; border-radius: 50%; display: inline-block; font-weight: 900; border: 2px solid #854d0e; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">ZAD ULTIMATE</div>
    <div class="nav-item active" onclick="app.showPage('dash', event)">ğŸ“Š Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-item" onclick="app.showPage('vols', event)">ğŸ‘¥ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</div>
    <div class="nav-item" onclick="app.showPage('eval', event)">ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</div>
    <div class="nav-item" onclick="app.showPage('vault', event)">ğŸ’¡ Ø®Ø²Ù†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹</div>
    <div class="nav-item" onclick="app.showPage('alerts', event)">ğŸš¨ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±</div>
</div>

<div class="main">
    <div id="radar-top" class="radar-alert">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±: Ù‡Ù†Ø§Ùƒ Ù…ØªØ·ÙˆØ¹ÙŠÙ† ÙŠØ­ØªØ§Ø¬ÙˆÙ† Ù„ØªØ¯Ø®Ù„ Ø¹Ø§Ø¬Ù„!</div>

    <div id="page-dash" class="page-section active">
        <div class="header"><h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ZAD 2026 ğŸŒ¿</h1></div>
        <div class="box">
            <h3>ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
            <div style="display:flex; gap:20px; margin-top:15px">
                <div style="flex:1; background:#ecfdf5; padding:20px; border-radius:12px; text-align:center">
                    <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</small><h2 id="st-vols">0</h2>
                </div>
                <div style="flex:1; background:#fef9c3; padding:20px; border-radius:12px; text-align:center">
                    <small>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù†Ø´Ø·Ø©</small><h2 id="st-alerts">0</h2>
                </div>
            </div>
        </div>
    </div>

    <div id="page-vols" class="page-section">
        <div class="header"><h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</h1> <button class="btn btn-primary" onclick="app.openModal('modal-vol')">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</button></div>
        <div class="box"><div id="vols-table-container"></div></div>
    </div>

    <div id="page-eval" class="page-section">
        <div class="header"><h1>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</h1></div>
        <div class="box">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹:</label>
            <select id="eval-vol-select" onchange="app.loadEvalFields()"></select>
            
            <div id="eval-form-body" style="display:none; margin-top:20px;">
                <div id="vol-info-badge" style="margin-bottom:15px"></div>
                <div id="dynamic-fields-container"></div>
                <label>ğŸ’¡ ÙÙƒØ±Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ© (ØªØ®Ø²Ù† ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø©)</label>
                <textarea id="eval-idea" placeholder="Ø§ÙƒØªØ¨ ÙÙƒØ±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ù‡Ù†Ø§..."></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:20px; padding:15px" onclick="app.submitEvaluation()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </div>
        <div id="report-output" class="box" style="display:none;"></div>
    </div>

    <div id="page-vault" class="page-section">
        <div class="header"><h1>Ø®Ø²Ù†Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ğŸ’¡</h1></div>
        <div id="vault-container"></div>
    </div>

    <div id="page-alerts" class="page-section">
        <div class="header"><h1>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªÙ†Ø¨Ø¤ ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø± ğŸš¨</h1></div>
        <div id="alerts-container"></div>
    </div>
</div>

<!-- Modal Vol -->
<div id="modal-vol" class="modal">
    <div class="modal-content">
        <form id="form-vol">
            <h3 id="modal-vol-title">Ø¥Ø¶Ø§ÙØ© Ù…ØªØ·ÙˆØ¹</h3><br>
            <input type="hidden" id="v-id">
            <div class="grid-form">
                <input type="text" id="v-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" required>
                <input type="tel" id="v-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            </div>
            <div class="grid-form">
                <input type="date" id="v-dob" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯">
                <input type="date" id="v-join" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…">
            </div>
            <select id="v-role" style="margin-bottom:15px">
                <option value="field">Ù…ØªØ·ÙˆØ¹ Ù…ÙŠØ¯Ø§Ù†ÙŠ</option>
                <option value="lead">Ù…Ø³Ø¦ÙˆÙ„ Ù…Ù„Ù</option>
            </select>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px">
                <input type="checkbox" id="v-frozen" style="width:auto"> <label style="margin:0">ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ¹ (ÙØ±ÙŠØ²) â„ï¸</label>
            </div>
            <textarea id="v-freeze-reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ (Ø¥Ù† ÙˆØ¬Ø¯)"></textarea>
            <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </form>
        <button class="btn" style="width:100%; margin-top:5px" onclick="app.closeModal('modal-vol')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
// **Ù‡Ø§Ù…:** Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
const API_URL = "https://costly-lucy-zad-project-7052acd0.koyeb.app/api"; 

const app = {
    data: { vols: [], criteria: [], alerts: [], vault: [] },

    async init() {
        await this.fetchData();
        document.getElementById('form-vol').addEventListener('submit', (e) => { e.preventDefault(); this.saveVol(); });
        this.renderAll();
    },

    async fetchData() {
        try {
            const [vols, crit, alerts, vault] = await Promise.all([
                fetch(`${API_URL}/volunteers`).then(r => r.json()),
                fetch(`${API_URL}/criteria`).then(r => r.json()),
                fetch(`${API_URL}/alerts`).then(r => r.json()),
                fetch(`${API_URL}/vault`).then(r => r.json())
            ]);
            this.data = { vols, criteria: crit, alerts, vault };
        } catch (err) { console.error("Fetch error:", err); }
    },

    showPage(id, event) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
    },

    openModal(id, editId = null) {
        if (id === 'modal-vol') {
            document.getElementById('form-vol').reset();
            if (editId) {
                const v = this.data.vols.find(x => x.id == editId);
                document.getElementById('v-id').value = v.id;
                document.getElementById('v-name').value = v.full_name;
                document.getElementById('v-phone').value = v.phone;
                document.getElementById('v-dob').value = v.birth_date ? v.birth_date.split('T')[0] : '';
                document.getElementById('v-join').value = v.join_date ? v.join_date.split('T')[0] : '';
                document.getElementById('v-role').value = v.role_type;
                document.getElementById('v-frozen').checked = v.is_frozen;
                document.getElementById('v-freeze-reason').value = v.freeze_reason || '';
            }
        }
        document.getElementById(id).style.display = 'flex';
    },

    closeModal(id) { document.getElementById(id).style.display = 'none'; },

    async saveVol() {
        const id = document.getElementById('v-id').value;
        const payload = {
            full_name: document.getElementById('v-name').value,
            phone: document.getElementById('v-phone').value,
            birth_date: document.getElementById('v-dob').value,
            join_date: document.getElementById('v-join').value,
            role_type: document.getElementById('v-role').value,
            is_frozen: document.getElementById('v-frozen').checked,
            freeze_reason: document.getElementById('v-freeze-reason').value
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/volunteers/${id}` : `${API_URL}/volunteers`;

        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            await this.init();
            this.closeModal('modal-vol');
        } else {
            alert('ÙØ´Ù„ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ¹. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
        }
    },

    loadEvalFields() {
        const vId = document.getElementById('eval-vol-select').value;
        if(!vId) return document.getElementById('eval-form-body').style.display = 'none';
        const vol = this.data.vols.find(v => v.id == vId);
        
        document.getElementById('vol-info-badge').innerHTML = `
            <span class="badge bg-rank">Ø§Ù„Ø±ØªØ¨Ø©: ${vol.rank}</span>
            <span class="badge bg-xp">XP: ${vol.xp_points}</span>
            ${vol.is_frozen ? '<span class="badge" style="background:#fee2e2; color:red">Ù…Ø¬Ù…Ø¯ â„ï¸</span>' : ''}
        `;
        
        let html = '';
        const categories = { basic: 'ğŸ“Œ Ø£Ø³Ø§Ø³ÙŠ', variable: 'ğŸ—“ï¸ Ù…ØªØºÙŠØ±', bonus: 'â­ Ø¨ÙˆÙ†Øµ' };
        for (let cat in categories) {
            // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ù‡Ù†Ø§
            const filtered = this.data.criteria.filter(c => c.category === cat && (c.target_role === 'all' || c.target_role === vol.role_type));
            if (filtered.length) {
                html += `<h4 style="margin:10px 0; color:var(--royal-green)">${categories[cat]}</h4><div class="grid-form">`;
                filtered.forEach(c => {
                    html += `<div><label>${c.name} (Ù…Ù† ${c.max_score})</label>
                             <input type="number" class="score-input" data-id="${c.id}" data-max="${c.max_score}" data-dna="${c.dna_type}" data-cat="${cat}" value="0" min="0" max="${c.max_score}">
                             <small style="color:red; cursor:pointer" onclick="document.querySelector('.score-input[data-id=\\'${c.id}\\']').value = 0">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</small>
                             </div>`;
                });
                html += `</div>`;
            }
        }
        document.getElementById('dynamic-fields-container').innerHTML = html;
        document.getElementById('eval-form-body').style.display = 'block';
    },

    async submitEvaluation() {
        const vId = document.getElementById('eval-vol-select').value;
        const scores = Array.from(document.querySelectorAll('.score-input')).map(i => ({
            criteria_id: i.dataset.id,
            score: i.value,
            max_score: i.dataset.max,
            dna_type: i.dataset.dna,
            category: i.dataset.cat
        }));

        const res = await fetch(`${API_URL}/evaluations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                volunteer_id: vId,
                eval_month: new Date().getMonth() + 1,
                eval_year: new Date().getFullYear(),
                scores,
                idea_text: document.getElementById('eval-idea').value
            })
        });

        const result = await res.json();
        if (result.success) {
            this.renderReport(result, vId);
            await this.init();
        } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ' + result.error);
        }
    },

    renderReport(res, vId) {
        const vol = this.data.vols.find(v => v.id == vId);
        const out = document.getElementById('report-output');
        out.innerHTML = `
            <div id="pdf-area" style="padding:20px; border:2px solid var(--primary); border-radius:15px">
                <h2 style="text-align:center; color:var(--royal-green)">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ÙƒÙŠ - ZAD 2026</h2>
                <hr style="margin:15px 0">
                <p><b>Ø§Ù„Ù…ØªØ·ÙˆØ¹:</b> ${vol.full_name} | <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${new Date().toLocaleDateString()}</p>
                <div style="text-align:center; margin:20px 0">
                    <h1 style="font-size:48px; color:var(--primary)">${res.percentage.toFixed(1)}%</h1>
                    ${res.hasAward ? '<div class="award-badge">ğŸ–ï¸ ÙˆØ³Ø§Ù… Ù†Ø¬Ù… Ø²Ø§Ø¯</div>' : ''}
                </div>
                <div style="background:#f0fdf4; padding:15px; border-radius:10px; margin-bottom:10px">
                    <b>ØªØ­Ù„ÙŠÙ„ DNA Ø§Ù„Ù…ØªØ·ÙˆØ¹:</b> ${res.dnaAnalysis}
                </div>
                <p style="font-style:italic; color:#666">ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù€ XP ÙˆØ§Ù„Ø±ØªØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="app.printPDF()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„ÙƒÙŠ PDF</button>
        `;
        out.style.display = 'block';
    },

    printPDF() { html2pdf().from(document.getElementById('pdf-area')).save('ZAD_Royal_Report.pdf'); },

    renderAll() {
        // Stats
        document.getElementById('st-vols').innerText = this.data.vols.length;
        document.getElementById('st-alerts').innerText = this.data.alerts.length;
        document.getElementById('radar-top').style.display = this.data.alerts.length > 0 ? 'block' : 'none';

        // Vols Table
        let vHtml = `<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>XP</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>`;
        this.data.vols.forEach(v => {
            vHtml += `<tr><td><b>${v.full_name}</b></td><td><span class="badge bg-rank">${v.rank}</span></td><td>${v.xp_points}</td>
            <td>${v.is_frozen ? 'â„ï¸ Ù…Ø¬Ù…Ø¯' : 'âœ… Ù†Ø´Ø·'}</td>
            <td><button class="btn btn-edit" onclick="app.openModal('modal-vol', '${v.id}')">ØªØ¹Ø¯ÙŠÙ„</button></td></tr>`;
        });
        document.getElementById('vols-table-container').innerHTML = vHtml + `</tbody></table>`;

        // Eval Select
        document.getElementById('eval-vol-select').innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…ØªØ·ÙˆØ¹ Ù„Ù„ØªÙ‚ÙŠÙŠÙ… --</option>' + 
            this.data.vols.map(v => `<option value="${v.id}">${v.full_name}</option>`).join('');

        // Vault
        document.getElementById('vault-container').innerHTML = this.data.vault.map(i => `
            <div class="box">
                <div style="display:flex; justify-content:space-between"><b>${i.full_name}</b> <small>${new Date(i.created_at).toLocaleDateString()}</small></div>
                <p style="margin-top:10px">${i.idea_text}</p>
            </div>
        `).join('');

        // Alerts
        document.getElementById('alerts-container').innerHTML = this.data.alerts.map(a => `
            <div class="box" style="border-right:5px solid var(--danger)">
                <b>${a.full_name}</b>: ${a.message}
                <div style="font-size:12px; color:#666; margin-top:5px">${new Date(a.created_at).toLocaleString()}</div>
            </div>
        `).join('');
    }
};

app.init();
</script>
</body>
</html>
