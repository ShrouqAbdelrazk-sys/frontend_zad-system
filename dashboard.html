<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… Ø²Ø§Ø¯ | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --main-green: #059669; --light-green: #10b981; --bg-soft: #f0fdf4; --danger: #ef4444; --blue: #3b82f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-soft); direction: rtl; color: #1f2937; }
        .header { background: var(--main-green); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 15px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; border-bottom: 5px solid var(--light-green); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-card .val { font-size: 35px; font-weight: 800; color: var(--main-green); }
        .stat-card .label { font-size: 14px; color: #6b7280; font-weight: 600; margin-top: 5px; }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .nav-btn { background: white; color: var(--main-green); padding: 25px 15px; border-radius: 15px; border: 2px solid var(--light-green); font-family: 'Cairo'; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .nav-btn:hover { background: var(--main-green); color: white; transform: translateY(-5px); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 95%; max-width: 900px; border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close { position: absolute; left: 25px; top: 20px; font-size: 30px; cursor: pointer; color: var(--danger); }
        .form-section { background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-right: 5px solid var(--main-green); }
        .btn-save { background: var(--main-green); color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #e5e7eb; }
        th { background: #f0fdf4; color: var(--main-green); }
        .btn-action { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; color: white; font-size: 12px; margin: 2px; transition: 0.2s; }
        .edit { background: var(--blue); } .edit:hover { background: #2563eb; }
        .delete { background: var(--danger); } .delete:hover { background: #dc2626; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-area"><h2>Ù…Ø´Ø±ÙˆØ¹ Ø²Ø§Ø¯ ğŸŒ¿</h2></div>
    <div class="user-nav">
        <span id="user-display">Ù…Ø±Ø­Ø¨Ø§Ù‹..</span>
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card"><div class="val" id="count-v">0</div><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</div></div>
        <div class="stat-card"><div class="val" id="avg-p">0%</div><div class="label">Ù…ØªÙˆØ³Ø· Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</div></div>
        <div class="stat-card"><div class="val" id="active-f">0</div><div class="label">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù†Ø´Ø·Ø©</div></div>
        <div class="stat-card"><div class="val" id="active-a">0</div><div class="label">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div></div>
    </div>

    <div class="nav-grid">
        <button class="nav-btn" onclick="openVolunteers()">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</button>
        <button class="nav-btn" onclick="openEvaluationForm()">ğŸ“‹ ØªÙ‚ÙŠÙŠÙ… Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯</button>
        <button class="nav-btn" onclick="fetchData('evaluations')">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
        <button class="nav-btn" onclick="openSettings()">âš–ï¸ Ù…ÙˆØ§Ø²ÙŠÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        <button class="nav-btn" onclick="fetchData('freeze')">â„ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±ÙŠØ² (Freeze)</button>
        <button class="nav-btn" onclick="fetchData('alerts')">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</button>
        <button class="nav-btn" onclick="fetchData('rewards')">ğŸ† Ø§Ù„Ø¨ÙˆÙ†Øµ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª</button>
        <button class="nav-btn" onclick="openAdminAccess()">ğŸ”‘ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙÙ‚ÙŠÙ…ÙŠÙ†</button>
    </div>
</div>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle" style="color: var(--main-green); margin-bottom: 20px;"></h3>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    const API_BASE = 'https://costly-lucy-zad-project-7052acd0.koyeb.app/api';

    window.onload = function() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('user-display').innerText = "Ø§Ù„Ù…ÙÙ‚ÙŠÙ…: " + (user.full_name || "Ø§Ù„Ø£Ø¯Ù…Ù†");
        refreshStats();
    };

    async function refreshStats() {
        try {
            const res = await fetch(`${API_BASE}/volunteers/statistics/overview`);
            const d = await res.json();
            document.getElementById('count-v').innerText = d.activeVolunteers || d.totalVolunteers || 0;
            document.getElementById('avg-p').innerText = (d.avgPerformance || 0) + "%";
            document.getElementById('active-f').innerText = d.activeAlerts || 0;
            document.getElementById('active-a').innerText = d.monthlyEvaluations || 0;
        } catch(e) { console.error("Stats Error"); }
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† (Ø¹Ø±Ø¶ØŒ Ø¥Ø¶Ø§ÙØ©ØŒ Ø­Ø°ÙØŒ ØªØ¹Ø¯ÙŠÙ„) ---
    async function openVolunteers() {
        const modal = document.getElementById('mainModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†";
        modal.style.display = "block";
        body.innerHTML = `
            <div class="form-section" id="vFormArea">
                <h4>â• Ø¥Ø¶Ø§ÙØ© Ù…ØªØ·ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h4>
                <input type="text" id="v_name" placeholder="Ø§Ù„Ø§Ø³Ù…" style="padding:10px; margin:5px; width:45%;">
                <input type="text" id="v_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="padding:10px; margin:5px; width:45%;">
                <button class="btn-save" id="saveVBtn" onclick="addNewVolunteer()">Ø­ÙØ¸ Ø§Ù„Ù…ØªØ·ÙˆØ¹</button>
            </div>
            <div id="vList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>
        `;
        loadVolunteersList();
    }

    async function loadVolunteersList() {
        try {
            const res = await fetch(`${API_BASE}/volunteers`);
            const data = await res.json();
            const container = document.getElementById('vList');
            
            let html = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th></tr>`;
            data.volunteers.forEach(v => {
                html += `<tr>
                    <td>${v.full_name}</td>
                    <td>${v.phone || '--'}</td>
                    <td>
                        <button class="btn-action edit" onclick="prepareEditVolunteer('${v.id}', '${v.full_name}', '${v.phone}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-action delete" onclick="deleteVolunteer('${v.id}')">Ø­Ø°Ù</button>
                    </td>
                </tr>`;
            });
            html += `</table>`;
            container.innerHTML = html;
        } catch(e) { document.getElementById('vList').innerHTML = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†."; }
    }

    async function addNewVolunteer() {
        const full_name = document.getElementById('v_name').value;
        const phone = document.getElementById('v_phone').value;
        if(!full_name || !phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
        
        try {
            const res = await fetch(`${API_BASE}/volunteers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ full_name, phone })
            });
            if(res.ok) { 
                document.getElementById('v_name').value = '';
                document.getElementById('v_phone').value = '';
                loadVolunteersList(); 
                refreshStats(); 
            }
        } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸."); }
    }

    async function deleteVolunteer(id) {
        if(!confirm("Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
        try {
            const res = await fetch(`${API_BASE}/volunteers/${id}`, { method: 'DELETE' });
            if(res.ok) { loadVolunteersList(); refreshStats(); }
            else { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°ÙØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù„Ù„Ù…ØªØ·ÙˆØ¹ Ø³Ø¬Ù„Ø§Øª ØªÙ‚ÙŠÙŠÙ… Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡."); }
        } catch(e) { alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±."); }
    }

    function prepareEditVolunteer(id, name, phone) {
        document.getElementById('v_name').value = name;
        document.getElementById('v_phone').value = phone;
        const btn = document.getElementById('saveVBtn');
        btn.innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù†";
        btn.style.background = "var(--blue)";
        btn.onclick = () => updateVolunteer(id);
    }

    async function updateVolunteer(id) {
        const full_name = document.getElementById('v_name').value;
        const phone = document.getElementById('v_phone').value;
        try {
            const res = await fetch(`${API_BASE}/volunteers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ full_name, phone })
            });
            if(res.ok) {
                alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
                openVolunteers(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙÙˆØ±Ù… ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©
            }
        } catch(e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„."); }
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ ---
    async function fetchData(type) {
        const modal = document.getElementById('mainModal');
        const body = document.getElementById('modalBody');
        const title = document.getElementById('modalTitle');
        modal.style.display = "block";
        body.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

        let endpoint = `/${type}`;
        try {
            const res = await fetch(`${API_BASE}${endpoint}`);
            const data = await res.json();
            if (type === 'evaluations') {
                title.innerText = "ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª";
                renderTable(body, ['Ø§Ù„Ù…ØªØ·ÙˆØ¹', 'Ø§Ù„Ù†Ø³Ø¨Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø©'], (data.evaluations || data).map(e => [e.volunteer_name || '---', e.percentage + '%', e.status]));
            } else if (type === 'alerts') {
                title.innerText = "ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª";
                renderTable(body, ['Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„ÙˆØµÙ'], (data.alerts || []).map(a => [a.type, a.description]));
            } else if (type === 'freeze') {
                title.innerText = "â„ï¸ Ø³Ø¬Ù„ Ø§Ù„ÙØ±ÙŠØ²";
                renderTable(body, ['Ù…ØªØ·ÙˆØ¹ ID', 'Ø§Ù„Ø³Ø¨Ø¨', 'Ø§Ù„ØªØ§Ø±ÙŠØ®'], (data.records || []).map(r => [r.volunteer_id, r.reason, new Date(r.start_date).toLocaleDateString()]));
            } else if (type === 'rewards') {
                title.innerText = "ğŸ† Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª";
                renderTable(body, ['Ø§Ù„Ù…ØªØ·ÙˆØ¹', 'Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©'], (data.rewards || []).map(r => [r.volunteer_name, r.reward_type]));
            }
        } catch (e) { body.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹."; }
    }

    function openSettings() {
        const modal = document.getElementById('mainModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "âš–ï¸ Ù…ÙˆØ§Ø²ÙŠÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…";
        modal.style.display = "block";
        renderTable(body, ['Ø§Ù„Ù…Ø¹ÙŠØ§Ø±', 'Ø§Ù„ÙˆØ²Ù†'], [['Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©', '25%'], ['Ø§Ù„ØªÙØ§Ø¹Ù„', '15%'], ['Ø§Ù„Ø¬ÙˆØ¯Ø©', '30%'], ['Ø§Ù„Ø¥ÙŠÙÙ†ØªØ§Øª', '20%'], ['Ø§Ù„Ø¨ÙˆÙ†Øµ', '10%']]);
    }

    function openAdminAccess() {
        const modal = document.getElementById('mainModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "ğŸ”‘ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙÙ‚ÙŠÙ…ÙŠÙ†";
        modal.style.display = "block";
        renderTable(body, ['Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø±ØªØ¨Ø©'], [['Ø´Ø±ÙˆÙ‚ Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚', 'Admin'], ['Ù…Ù‚ÙŠÙ… Ø²Ø§Ø¯', 'Evaluator']]);
    }

    function openEvaluationForm() {
        const modal = document.getElementById('mainModal');
        const body = document.getElementById('modalBody');
        document.getElementById('modalTitle').innerText = "ğŸ“‹ Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ø´Ù‡Ø±ÙŠ";
        modal.style.display = "block";
        body.innerHTML = `<div class="form-section">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ·ÙˆØ¹</label><input type="text" style="width:100%; padding:10px; margin-bottom:10px;">
            <label>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</label><input type="number" style="width:100%; padding:10px; margin-bottom:10px;">
            <button class="btn-save" onclick="alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­!')">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        </div>`;
    }

    function renderTable(container, headers, rows) {
        if (!rows || rows.length === 0) { container.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª."; return; }
        let html = `<table><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        rows.forEach(row => { html += `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`; });
        html += `</table>`;
        container.innerHTML = html;
    }

    function closeModal() { document.getElementById('mainModal').style.display = "none"; }
    function logout() { localStorage.clear(); window.location.replace('index.html'); }
</script>
</body>
</html>
