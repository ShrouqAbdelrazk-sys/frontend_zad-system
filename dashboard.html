<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZAD OMNI | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main: #059669; --dark: #064e3b; --bg: #f3f4f6; --text: #1f2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .admin-bar { background: var(--dark); color: white; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .quick-actions { display: flex; gap: 10px; }
        .quick-actions button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .quick-actions button:hover { background: var(--main); }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { background: white; padding: 40px 20px; text-align: center; border-bottom: 1px solid #e5e7eb; }
        .header h1 { font-weight: 900; font-size: 2.5rem; color: var(--dark); letter-spacing: -1px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯ (Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª) */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .nav-card { background: white; padding: 40px 20px; border-radius: 20px; text-align: center; cursor: pointer; border: 1px solid #eee; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .nav-card:hover { transform: translateY(-5px); border-color: var(--main); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .nav-card i { font-size: 40px; display: block; margin-bottom: 15px; }
        .nav-card h3 { font-weight: 800; color: var(--dark); }

        /* Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø© */
        .page { display: none; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--bg); padding-bottom: 15px; }
        .btn-back { background: #6b7280; color: white; border: none; padding: 8px 18px; border-radius: 10px; cursor: pointer; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ÙÙˆØ±Ù… */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--dark); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; }
        .btn-save { background: var(--main); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: 800; cursor: pointer; font-size: 16px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f3f4f6; }
        th { background: #f9fafb; color: var(--dark); font-weight: 800; }

        .report-box { border: 2px solid var(--main); padding: 30px; border-radius: 20px; background: #fff; margin-top: 20px; }
    </style>
</head>
<body>

<div class="admin-bar">
    <div style="font-weight: 900; font-size: 18px; letter-spacing: 1px;">ZAD OMNI</div>
    <div class="quick-actions">
        <button onclick="omni.showPage('page-vols')">+ Ù…ØªØ·ÙˆØ¹</button>
        <button onclick="omni.showPage('page-criteria')">+ Ù…Ø¹ÙŠØ§Ø±</button>
        <button onclick="omni.showPage('page-eval')">+ ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
</div>

<div id="main-content">
    <div id="page-home">
        <div class="header">
            <h1>ZAD OMNI</h1>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p>
        </div>
        <div class="container">
            <div class="dashboard-grid">
                <div class="nav-card" onclick="omni.showPage('page-vols')"><i>ğŸ‘¥</i><h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3><p>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ø±</p></div>
                <div class="nav-card" onclick="omni.showPage('page-eval')"><i>ğŸš€</i><h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3><p>ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø§Ø±ÙŠØ± PDF Ø°ÙƒÙŠØ©</p></div>
                <div class="nav-card" onclick="omni.showPage('page-criteria')"><i>ğŸ“</i><h3>Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h3><p>ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p></div>
                <div class="nav-card" onclick="omni.showPage('page-vault')"><i>ğŸ’¡</i><h3>Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙÙƒØ§Ø±</h3><p>Ø®Ø²Ù†Ø© Ø¥Ø¨Ø¯Ø§Ø¹Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚</p></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="page-vols" class="page">
            <div class="page-header"><h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</h2><button class="btn-back" onclick="omni.showPage('page-home')">Ø¹ÙˆØ¯Ø©</button></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="v-name">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="v-birth" onchange="omni.autoAge(this.value)">
                    <label>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨</label><input id="v-age" disabled style="background: #f9fafb;">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø²Ø§Ø¯</label><input type="date" id="v-join">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label><textarea id="v-note" rows="4"></textarea>
                </div>
            </div>
            <button class="btn-save" onclick="omni.saveVol()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¹Ø¯Ø©</button>
            <div id="v-list-box"></div>
        </div>

        <div id="page-criteria" class="page">
            <div class="page-header"><h2>Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2><button class="btn-back" onclick="omni.showPage('page-home')">Ø¹ÙˆØ¯Ø©</button></div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</label><input id="c-name">
                <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰</label><input type="number" id="c-max">
                <button class="btn-save" style="margin-top:10px" onclick="omni.saveCriteria()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</button>
            </div>
            <div id="c-list-box"></div>
        </div>

        <div id="page-eval" class="page">
            <div class="page-header"><h2>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ</h2><button class="btn-back" onclick="omni.showPage('page-home')">Ø¹ÙˆØ¯Ø©</button></div>
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹</label><select id="ev-select"></select>
            <div id="dynamic-eval" style="margin-top:20px"></div>
            <label>ÙÙƒØ±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><textarea id="ev-idea" placeholder="Ø§ÙƒØªØ¨ÙŠ ÙÙƒØ±ØªÙ‡ Ù‡Ù†Ø§ Ù„ØªÙØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ"></textarea>
            <button class="btn-save" onclick="omni.generateReport()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
            <div id="report-output"></div>
        </div>

        <div id="page-vault" class="page">
            <div class="page-header"><h2>Ø®Ø²Ù†Ø© Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</h2><button class="btn-back" onclick="omni.showPage('page-home')">Ø¹ÙˆØ¯Ø©</button></div>
            <div id="vault-box"></div>
        </div>
    </div>
</div>

<script>
    const API = 'https://costly-lucy-zad-project-7052acd0.koyeb.app/api';
    
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    let criteria = JSON.parse(localStorage.getItem('omni_c')) || [{id:1, name:'Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·', max:10}, {id:2, name:'Ø§Ù„ØªÙØ§Ø¹Ù„', max:10}];
    let volunteers = [];

    const omni = {
        async init() {
            this.loadVols();
            this.renderCriteria();
        },
        showPage(pageId) {
            document.querySelectorAll('.page, #page-home').forEach(p => p.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
            if(pageId === 'page-eval') this.prepareEval();
        },

        // --- Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† ---
        autoAge(val) {
            if(!val) return;
            const age = new Date().getFullYear() - new Date(val).getFullYear();
            document.getElementById('v-age').value = age + " Ø³Ù†Ø©";
        },
        async saveVol() {
            const name = document.getElementById('v-name').value;
            if(!name) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù…");
            const payload = { full_name: name, phone: document.getElementById('v-age').value, role: document.getElementById('v-note').value };
            await fetch(`${API}/volunteers`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©!"); this.loadVols();
        },
        async loadVols() {
            const res = await fetch(`${API}/volunteers`);
            const d = await res.json();
            volunteers = d.volunteers;
            let h = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
            volunteers.forEach(v => {
                h += `<tr><td>${v.full_name}</td><td>${v.phone || '--'}</td><td><button onclick="omni.delV('${v.id}')" style="color:red; border:none; background:none; cursor:pointer">Ø­Ø°Ù</button></td></tr>`;
            });
            document.getElementById('v-list-box').innerHTML = h + `</table>`;
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
            const sel = document.getElementById('ev-select');
            if(sel) sel.innerHTML = volunteers.map(v => `<option value="${v.id}">${v.full_name}</option>`).join('');
        },
        async delV(id) { if(confirm("Ø­Ø°ÙØŸ")) { await fetch(`${API}/volunteers/${id}`, {method:'DELETE'}); this.loadVols(); } },

        // --- Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ---
        renderCriteria() {
            let h = `<table><tr><th>Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
            criteria.forEach(c => h += `<tr><td>${c.name}</td><td>${c.max}</td><td><button onclick="omni.delC(${c.id})" style="color:red; border:none; background:none; cursor:pointer">Ø­Ø°Ù</button></td></tr>`);
            document.getElementById('c-list-box').innerHTML = h + `</table>`;
        },
        saveCriteria() {
            const n = document.getElementById('c-name').value;
            const m = document.getElementById('c-max').value;
            if(!n || !m) return;
            criteria.push({id:Date.now(), name:n, max:m});
            localStorage.setItem('omni_c', JSON.stringify(criteria));
            this.renderCriteria();
        },
        delC(id) { criteria = criteria.filter(c => c.id !== id); localStorage.setItem('omni_c', JSON.stringify(criteria)); this.renderCriteria(); },

        // --- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± ---
        prepareEval() {
            document.getElementById('dynamic-eval').innerHTML = criteria.map(c => `
                <div class="form-group">
                    <label>${c.name} (Ù…Ù† ${c.max})</label>
                    <input type="number" class="ev-inp" data-name="${c.name}" data-max="${c.max}">
                </div>
            `).join('');
        },
        async generateReport() {
            let s = [], w = [], total = 0, max = 0;
            const name = document.getElementById('ev-select').options[document.getElementById('ev-select').selectedIndex].text;
            
            document.querySelectorAll('.ev-inp').forEach(i => {
                let val = parseInt(i.value) || 0;
                let mx = parseInt(i.dataset.max);
                total += val; max += mx;
                if(val >= mx * 0.8) s.push(i.dataset.name);
                else if(val < mx * 0.5) w.push(i.dataset.name);
            });

            const score = ((total/max)*100).toFixed(1);
            const idea = document.getElementById('ev-idea').value;

            document.getElementById('report-output').innerHTML = `
                <div class="report-box" id="pdf-content">
                    <h2 style="color:var(--main); text-align:center">ZAD OMNI | ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
                    <p style="text-align:center; margin-bottom:20px">Ù„Ù„Ù…ØªØ·ÙˆØ¹: ${name}</p>
                    <hr style="margin-bottom:20px">
                    <p><b>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©:</b> ${score}%</p>
                    <p><b>Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</b> ${s.join('ØŒ ') || 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„'}</p>
                    <p><b>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</b> ${w.join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø­ÙˆØ¸Ø§Øª'}</p>
                    ${idea ? `<p><b>Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</b> ${idea}</p>` : ''}
                    <button class="btn-save" style="margin-top:20px; background:var(--dark)" onclick="omni.downloadPDF()">ØªØ­Ù…ÙŠÙ„ PDF Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                </div>
            `;
            
            // Ø­ÙØ¸ Ø§Ù„ÙÙƒØ±Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ€ Note Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            if(idea) {
                const vId = document.getElementById('ev-select').value;
                await fetch(`${API}/evaluations`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({volunteer_id: vId, percentage: score, notes: idea, evaluation_month: 12, evaluation_year: 2025}) });
            }
        },
        downloadPDF() {
            const el = document.getElementById('pdf-content');
            html2pdf().from(el).set({margin:1, filename:'ZAD_Report.pdf', image:{type:'jpeg', quality:0.98}}).save();
        },

        async openVault() {
            this.showPage('page-vault');
            const res = await fetch(`${API}/evaluations`);
            const d = await res.json();
            document.getElementById('vault-box').innerHTML = d.map(e => `
                <div style="background:#f9fafb; padding:15px; border-radius:15px; margin-bottom:10px; border-right:5px solid var(--main)">
                    <b>${e.volunteer_name}:</b><br>${e.notes}
                </div>
            `).join('') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙÙƒØ§Ø± Ù…Ø®Ø²Ù†Ø©.";
        }
    };

    omni.init();
</script>
</body>
</html>
