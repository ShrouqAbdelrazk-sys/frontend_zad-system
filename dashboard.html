<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZAD OMNI | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main: #10b981; --dark: #065f46; --bg: #f3f4f6; --border: #e5e7eb; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: #374151; }
        
        /* Navbar */
        .navbar { background: white; padding: 15px 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); }
        .logo { font-weight: 900; font-size: 24px; color: var(--dark); letter-spacing: 1px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .dash-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; text-align: center; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .dash-card:hover { border-color: var(--main); transform: translateY(-3px); background: #f9fafb; }
        .dash-card b { display: block; font-size: 22px; margin-bottom: 8px; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± (Ø²ÙŠ Ø§Ù„ØµÙˆØ±Ø©) */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .category-label { color: var(--main); font-weight: 800; margin: 25px 0 15px; font-size: 20px; border-right: 4px solid var(--main); padding-right: 10px; }
        .criteria-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .c-card { background: white; border-radius: 15px; padding: 25px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .c-card h4 { font-weight: 800; margin-bottom: 8px; color: #111827; }
        .c-card p { font-size: 14px; color: #6b7280; margin-bottom: 20px; line-height: 1.6; }
        .points-tag { background: #ecfdf5; color: var(--dark); padding: 8px; border-radius: 10px; font-weight: 700; font-size: 14px; text-align: center; border: 1px solid #d1fae5; }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 550px; border-radius: 20px; overflow: hidden; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { background: #f9fafb; padding: 20px; font-weight: 800; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; }

        /* Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 15px; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; margin-bottom: 20px; font-size: 15px; outline: none; }
        input:focus { border-color: var(--main); }
        .btn-action { background: var(--main); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-action:hover { background: var(--dark); }
        
        .btn-del { background: none; border: 1px solid #fee2e2; color: var(--danger); padding: 8px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 600; }
        .btn-del:hover { background: #fef2f2; }

        table { width: 100%; margin-top: 10px; }
        th, td { text-align: right; padding: 15px; border-bottom: 1px solid #f3f4f6; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="logo">ZAD OMNI</div>
    <div style="color: #9ca3af; font-weight: 600;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</div>
</div>

<div class="container">
    <div class="dash-grid">
        <button class="dash-card" onclick="app.openVols()"><b>ğŸ‘¤</b> Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</button>
        <button class="dash-card" onclick="app.openEval()"><b>ğŸ“</b> ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯</button>
        <button class="dash-card" onclick="app.openCriteria()"><b>âš™ï¸</b> Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</button>
        <button class="dash-card" onclick="app.openVault()"><b>ğŸ’¡</b> Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙÙƒØ§Ø±</button>
        <button class="dash-card" onclick="app.openSettings()"><b>ğŸ”’</b> Ø§Ù„Ø£Ù…Ø§Ù†</button>
    </div>

    <div class="section-header">
        <h2 style="font-weight: 800; color: #111827;">Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
        <button onclick="app.addCriteriaModal()" style="background:var(--dark); color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:700;">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø±</button>
    </div>

    <div id="criteria-container">
        </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="m-title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
            <span style="cursor:pointer; font-size: 24px;" onclick="app.close()">&times;</span>
        </div>
        <div class="modal-body" id="m-body"></div>
    </div>
</div>

<script>
    const API = 'https://costly-lucy-zad-project-7052acd0.koyeb.app/api';
    
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
    let criteria = JSON.parse(localStorage.getItem('zad_criteria_v5')) || [
        {id: 1, name: 'Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙŠØªÙŠÙ†Ø¬', desc: 'Ù…Ø¯Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø­Ø¶ÙˆØ± Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ±ÙŠØ© ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©', max: 10, cat: 'Ø£Ù†Ø´Ø·Ø© Ø«Ø§Ø¨ØªØ©'},
        {id: 2, name: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©', desc: 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª', max: 10, cat: 'Ø£Ù†Ø´Ø·Ø© Ø«Ø§Ø¨ØªØ©'}
    ];

    const app = {
        async init() { this.renderCriteria(); },
        open(title) { document.getElementById('m-title').innerText = title; document.getElementById('modal').style.display = 'flex'; },
        close() { document.getElementById('modal').style.display = 'none'; },

        // --- 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ---
        renderCriteria() {
            const container = document.getElementById('criteria-container');
            const cats = [...new Set(criteria.map(c => c.cat))];
            container.innerHTML = cats.map(cat => `
                <h3 class="category-label">${cat}</h3>
                <div class="criteria-grid">
                    ${criteria.filter(c => c.cat === cat).map(c => `
                        <div class="c-card">
                            <h4>${c.name}</h4>
                            <p>${c.desc}</p>
                            <div class="points-tag">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${c.max} Ù†Ù‚Ø§Ø·</div>
                            <button class="btn-del" onclick="app.deleteC(${c.id})">Ø­Ø°Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</button>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        },
        addCriteriaModal() {
            this.open("Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯");
            document.getElementById('m-body').innerHTML = `
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</label><input id="cn" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ">
                <label>ÙˆØµÙ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</label><textarea id="cd" rows="3" placeholder="Ø§Ø´Ø±Ø­ Ù„Ù„Ù…Ù‚ÙŠÙ… Ø¥Ø²Ø§ÙŠ ÙŠØ­Ø· Ø§Ù„Ø¯Ø±Ø¬Ø©"></textarea>
                <label>Ø§Ù„ÙØ¦Ø©</label><input id="cc" type="text" placeholder="Ø£Ù†Ø´Ø·Ø© Ø«Ø§Ø¨ØªØ© / Ù…ØªØºÙŠØ±Ø©">
                <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰</label><input id="cm" type="number" placeholder="10">
                <button class="btn-action" onclick="app.saveC()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹ÙŠØ§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            `;
        },
        saveC() {
            const n = document.getElementById('cn').value;
            if(!n) return;
            criteria.push({ id: Date.now(), name: n, desc: document.getElementById('cd').value, max: document.getElementById('cm').value, cat: document.getElementById('cc').value });
            localStorage.setItem('zad_criteria_v5', JSON.stringify(criteria));
            this.renderCriteria(); this.close();
        },
        deleteC(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { criteria = criteria.filter(c => c.id !== id); localStorage.setItem('zad_criteria_v5', JSON.stringify(criteria)); this.renderCriteria(); } },

        // --- 2. Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† (Ø¥ØµÙ„Ø§Ø­ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø¶Ø§ÙØ©) ---
        async openVols() {
            this.open("Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø§Ø¦Ù„Ø© Ø²Ø§Ø¯");
            document.getElementById('m-body').innerHTML = `
                <div style="background:#f9fafb; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ·ÙˆØ¹</label><input id="v-name" type="text">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="v-phone" type="text">
                    <button class="btn-action" onclick="app.saveVol()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ø§Ù„Ø¢Ù†</button>
                </div>
                <div id="v-list-data">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†...</div>
            `;
            this.loadVols();
        },
        async saveVol() {
            const name = document.getElementById('v-name').value;
            const phone = document.getElementById('v-phone').value;
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");
            
            const res = await fetch(`${API}/volunteers`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({full_name: name, phone: phone, role: 'Ø¹Ø¶Ùˆ'})
            });
            if(res.ok) { this.loadVols(); document.getElementById('v-name').value = ""; document.getElementById('v-phone').value = ""; }
        },
        async loadVols() {
            const res = await fetch(`${API}/volunteers`);
            const data = await res.json();
            document.getElementById('v-list-data').innerHTML = `<table>` + data.volunteers.map(v => `<tr><td><b>${v.full_name}</b></td><td style="text-align:left"><button onclick="app.delV('${v.id}')" style="color:var(--danger); border:none; background:none; cursor:pointer">Ø­Ø°Ù</button></td></tr>`).join('') + `</table>`;
        },
        async delV(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ØªØ·ÙˆØ¹ØŸ")) { await fetch(`${API}/volunteers/${id}`, {method:'DELETE'}); this.loadVols(); } },

        // --- 3. Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©/Ø§Ù„Ø¶Ø¹Ù + Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±) ---
        async openEval() {
            const res = await fetch(`${API}/volunteers`);
            const data = await res.json();
            if(data.volunteers.length === 0) return alert("Ø£Ø¶ÙŠÙÙŠ Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹");
            
            this.open("Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡");
            const vOpts = data.volunteers.map(v => `<option value="${v.id}">${v.full_name}</option>`).join('');
            document.getElementById('m-body').innerHTML = `
                <label>Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹</label><select id="ev-id">${vOpts}</select>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                    <div><label>Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</label><textarea id="ev-s" rows="3" placeholder="Ø§ÙŠÙ‡ Ø§Ù„Ù…ÙŠØ² Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ØŸ"></textarea></div>
                    <div><label>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù</label><textarea id="ev-w" rows="3" placeholder="Ù…Ø­ØªØ§Ø¬ ÙŠØ·ÙˆØ± Ø§ÙŠÙ‡ØŸ"></textarea></div>
                </div>
                <label>ÙÙƒØ±Ø© Ø§Ù„Ø´Ù‡Ø± / Ø§Ù‚ØªØ±Ø§Ø­Ù‡</label><textarea id="ev-idea" rows="2"></textarea>
                <hr style="margin:15px 0; border:none; border-top:1px solid #eee">
                <div id="dynamic-eval-fields">
                    ${criteria.map(c => `<label>${c.name} (Ù…Ù† ${c.max})</label><input type="number" class="ev-inp" data-max="${c.max}" data-name="${c.name}" placeholder="0 - ${c.max}">`).join('')}
                </div>
                <button class="btn-action" onclick="app.saveEval()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            `;
        },
        async saveEval() {
            let totalGot = 0, totalMax = 0, lowScores = [];
            document.querySelectorAll('.ev-inp').forEach(input => {
                let val = parseInt(input.value) || 0;
                let max = parseInt(input.dataset.max);
                totalGot += val; totalMax += max;
                if(val < max/2) lowScores.push(input.dataset.name);
            });

            if(lowScores.length > 0) alert("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ù…Ø³ØªÙˆØ§Ù‡ Ø¶Ø¹ÙŠÙ ÙÙŠ: " + lowScores.join('ØŒ '));

            const percent = ((totalGot/totalMax)*100).toFixed(1);
            const payload = {
                volunteer_id: document.getElementById('ev-id').value,
                percentage: percent,
                notes: `Idea: ${document.getElementById('ev-idea').value} | S: ${document.getElementById('ev-s').value} | W: ${document.getElementById('ev-w').value}`,
                evaluation_month: 12, evaluation_year: 2025
            };
            await fetch(`${API}/evaluations`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            alert(`ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${percent}%`); this.close();
        },

        // --- 4. Ø§Ù„Ø£Ù…Ø§Ù† ---
        openSettings() {
            this.open("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†");
            document.getElementById('m-body').innerHTML = `
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input id="new-pass" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
                <button class="btn-action" onclick="app.updatePass()">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            `;
        },
        updatePass() {
            const p = document.getElementById('new-pass').value;
            if(p) { localStorage.setItem('zad_admin_pass', p); alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«! Ø³ÙŠØªÙ… Ø·Ù„Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…."); this.close(); }
        },

        async openVault() {
            this.open("Ø®Ø²Ù†Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±");
            const res = await fetch(`${API}/evaluations`);
            const data = await res.json();
            document.getElementById('m-body').innerHTML = data.map(e => `
                <div style="background:#f9fafb; padding:15px; border-radius:10px; margin-bottom:10px; border-right:4px solid var(--main)">
                    <b>${e.volunteer_name}:</b><br>${e.notes.split('|')[0]}
                </div>`).join('') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙÙƒØ§Ø± Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.";
        }
    };

    app.init();
</script>
</body>
</html>
