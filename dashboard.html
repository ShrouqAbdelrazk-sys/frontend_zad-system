<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZAD ADMIN | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --zad-green: #059669; --zad-dark: #064e3b; --zad-bg: #f1f5f9; --gold: #fbbf24; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: var(--zad-bg); direction: rtl; color: #1e293b; }
        .header { background: linear-gradient(135deg, var(--zad-dark), var(--zad-green)); color: white; padding: 20px 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .main-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .action-card { background: white; padding: 40px 20px; border-radius: 30px; border: none; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 15px; font-weight: 900; font-size: 18px; }
        .action-card:hover { transform: translateY(-10px); background: var(--zad-dark); color: white; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal-content { background: white; max-width: 900px; margin: auto; padding: 40px; border-radius: 35px; position: relative; }
        .close { position: absolute; left: 25px; top: 15px; font-size: 35px; cursor: pointer; color: var(--danger); }

        /* Ø§Ù„ÙÙˆØ±Ù… ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .form-section { background: #f8fafc; padding: 25px; border-radius: 20px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
        label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--zad-dark); }
        input, select, textarea { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Cairo'; margin-bottom: 15px; }
        .btn-prime { background: var(--zad-green); color: white; border: none; padding: 15px 30px; border-radius: 12px; cursor: pointer; font-weight: 900; width: 100%; font-size: 16px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        .badge { padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; }
        .badge-green { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div class="header">
    <div><h1>ZAD COMMANDER ğŸ‘‘</h1><p>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯Ø© Ø´Ø±ÙˆÙ‚ Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚</p></div>
    <div style="font-weight: 900; font-size: 20px;">v3.0 - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…ØªØ·ÙˆØ±</div>
</div>

<div class="container">
    <div class="main-grid">
        <button class="action-card" onclick="admin.openVols()">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</button>
        <button class="action-card" onclick="admin.openCriteria()">ğŸ“ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        <button class="action-card" onclick="admin.openAdmins()">ğŸ”‘ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙÙ‚ÙŠÙ…ÙŠÙ†</button>
        <button class="action-card" onclick="admin.openEval()">ğŸš€ Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ…</button>
        <button class="action-card" onclick="admin.openVault()">ğŸ’¡ Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙÙƒØ§Ø±</button>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="admin.close()">&times;</span>
        <h2 id="m-title" style="margin-bottom:25px; border-bottom: 2px solid var(--zad-green); padding-bottom: 10px;"></h2>
        <div id="m-body"></div>
    </div>
</div>

<script>
    const API = 'https://costly-lucy-zad-project-7052acd0.koyeb.app/api';
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙˆØ§Ù„Ù…Ù‚ÙŠÙ…ÙŠÙ† (ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ localStorage Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
    let criteria = JSON.parse(localStorage.getItem('zad_criteria')) || [
        {id: 1, name: 'Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ', weight: 10},
        {id: 2, name: 'Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø±Ø¯', weight: 10}
    ];

    let subAdmins = JSON.parse(localStorage.getItem('zad_admins')) || [];
    let volunteers = [];

    const admin = {
        async init() {
            const res = await fetch(`${API}/volunteers`);
            const data = await res.json();
            volunteers = data.volunteers || [];
        },
        open(t) { document.getElementById('m-title').innerText = t; document.getElementById('modal').style.display = 'block'; },
        close() { document.getElementById('modal').style.display = 'none'; },

        // 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ù…Ø³Ø­)
        openCriteria() {
            this.open("ğŸ“ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");
            let list = criteria.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.weight} Ù†Ù‚Ø§Ø·</td>
                    <td>
                        <button onclick="admin.deleteCriterion(${c.id})" style="color:red; border:none; background:none; cursor:pointer;">Ù…Ø³Ø­</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('m-body').innerHTML = `
                <div class="form-section">
                    <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯</h4>
                    <input id="c-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø± (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯)">
                    <input id="c-weight" type="number" placeholder="Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù†Ø³Ø¨ÙŠ (Ù…Ø«Ù„Ø§Ù‹: 10)">
                    <button class="btn-prime" onclick="admin.addCriterion()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</button>
                </div>
                <table><tr><th>Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>${list}</table>
            `;
        },
        addCriterion() {
            const name = document.getElementById('c-name').value;
            const weight = document.getElementById('c-weight').value;
            if(!name || !weight) return alert("Ø§ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            criteria.push({id: Date.now(), name, weight: parseInt(weight)});
            localStorage.setItem('zad_criteria', JSON.stringify(criteria));
            this.openCriteria();
        },
        deleteCriterion(id) {
            criteria = criteria.filter(c => c.id !== id);
            localStorage.setItem('zad_criteria', JSON.stringify(criteria));
            this.openCriteria();
        },

        // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙÙ‚ÙŠÙ…ÙŠÙ† (Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©)
        openAdmins() {
            this.open("ğŸ”‘ Ø¥Ø¶Ø§ÙØ© ÙˆØªÙÙˆÙŠØ¶ Ø§Ù„Ù…ÙÙ‚ÙŠÙ…ÙŠÙ†");
            let cOpts = criteria.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            let list = subAdmins.map(a => `
                <tr>
                    <td>${a.name}</td>
                    <td>${a.email}</td>
                    <td><span class="badge badge-green">${a.scope}</span></td>
                </tr>
            `).join('');

            document.getElementById('m-body').innerHTML = `
                <div class="form-section">
                    <h4>Ø¯Ø¹ÙˆØ© Ù…ÙÙ‚ÙŠÙ… Ø¬Ø¯ÙŠØ¯</h4>
                    <input id="adm-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙÙ‚ÙŠÙ…">
                    <input id="adm-email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ @)">
                    <label>Ù…Ø§Ø°Ø§ Ø³ÙŠÙ‚ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ</label>
                    <select id="adm-scope">
                        <option value="Ø§Ù„ÙƒÙ„">ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</option>
                        ${cOpts}
                    </select>
                    <button class="btn-prime" onclick="admin.addAdmin()">ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„</button>
                </div>
                <table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ù…Ø¬Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th></tr>${list}</table>
            `;
        },
        addAdmin() {
            const name = document.getElementById('adm-name').value;
            const email = document.getElementById('adm-email').value;
            const scope = document.getElementById('adm-scope').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if(!emailRegex.test(email)) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­!");
            
            subAdmins.push({name, email, scope});
            localStorage.setItem('zad_admins', JSON.stringify(subAdmins));
            this.openAdmins();
        },

        // 3. Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±)
        async openEval() {
            await this.init();
            this.open("ğŸš€ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ");
            const vOpts = volunteers.map(v => `<option value="${v.id}">${v.full_name}</option>`).join('');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            let cFields = criteria.map(c => `
                <label>${c.name} (Ù…Ù† ${c.weight})</label>
                <input type="number" class="c-val" data-weight="${c.weight}" placeholder="0 - ${c.weight}">
            `).join('');

            document.getElementById('m-body').innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px">
                    <div>
                        <label>Ø§Ù„Ù…ØªØ·ÙˆØ¹</label><select id="ev-id">${vOpts}</select>
                        ${cFields}
                    </div>
                    <div>
                        <label>ğŸ’¡ ÙÙƒØ±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹</label><textarea id="ev-idea" rows="5"></textarea>
                        <label>â¤ï¸ Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ±</label><textarea id="ev-note" rows="5"></textarea>
                    </div>
                </div>
                <button class="btn-prime" onclick="admin.saveEval()">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            `;
        },
        async saveEval() {
            let totalGot = 0, totalMax = 0;
            document.querySelectorAll('.c-val').forEach(input => {
                totalGot += parseInt(input.value) || 0;
                totalMax += parseInt(input.getAttribute('data-weight'));
            });
            const score = ((totalGot / totalMax) * 100).toFixed(1);
            
            const payload = {
                volunteer_id: document.getElementById('ev-id').value,
                percentage: score, evaluation_month: 12, evaluation_year: 2025,
                notes: `${document.getElementById('ev-idea').value} | DNA: ØªØ­Ù„ÙŠÙ„ Ø¢Ù„ÙŠ | ${document.getElementById('ev-note').value}`,
                status: score >= 90 ? 'Ù…ØªÙ…ÙŠØ²' : 'Ù†Ø´Ø·'
            };
            await fetch(`${API}/evaluations`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            alert(`ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${score}%`);
            this.close();
        },

        // Ø§Ù„Ø¨Ø§Ù‚ÙŠ (Ù…ØªØ·ÙˆØ¹ÙŠÙ† ÙˆØ¨Ù†Ùƒ Ø§Ù„Ø£ÙÙƒØ§Ø±)
        async openVols() {
            this.open("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†");
            document.getElementById('m-body').innerHTML = `
                <input id="vn" placeholder="Ø§Ù„Ø§Ø³Ù…"><input id="vp" placeholder="Ø§Ù„Ù‡Ø§ØªÙ"><input id="vn" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ¹">
                <button class="btn-prime" onclick="admin.addV()">Ø¥Ø¶Ø§ÙØ©</button>
                <div id="vlist"></div>
            `;
            this.renderVols();
        },
        async addV() {
            await fetch(`${API}/volunteers`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({full_name:document.getElementById('vn').value, phone:document.getElementById('vp').value, role:'Ø¹Ø¶Ùˆ'}) });
            this.renderVols();
        },
        async renderVols() {
            const res = await fetch(`${API}/volunteers`);
            const d = await res.json();
            let h = `<table>`;
            d.volunteers.forEach(v => h += `<tr><td>${v.full_name}</td><td><button onclick="admin.delV('${v.id}')">Ø­Ø°Ù</button></td></tr>`);
            document.getElementById('vlist').innerHTML = h + `</table>`;
        },
        async delV(id) { await fetch(`${API}/volunteers/${id}`, {method:'DELETE'}); this.renderVols(); },
        async openVault() {
            this.open("ğŸ’¡ Ø¨Ù†Ùƒ Ø§Ù„Ø£ÙÙƒØ§Ø±");
            const res = await fetch(`${API}/evaluations`);
            const data = await res.json();
            document.getElementById('m-body').innerHTML = data.map(e => `<div class="form-section"><b>${e.volunteer_name}:</b><br>${e.notes.split('|')[0]}</div>`).join('');
        }
    };

    admin.init();
</script>
</body>
</html>
